<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BFGMiner Admin Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/admin.css" rel="stylesheet">
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center">
    <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">BFGMiner Admin</h1>
            <div class="w-16 h-16 bg-gradient-to-r from-green-400 to-green-600 rounded-full mx-auto mb-4"></div>
            <p class="text-gray-400">Administrator Dashboard Login</p>
        </div>
        
        <form id="adminLoginForm" class="space-y-6">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                <input type="text" id="username" name="username" required
                       class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="admin">
            </div>
            
            <div>
                <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                <input type="password" id="password" name="password" required
                       class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="Enter password">
            </div>
            
            <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                <span id="loginButtonText">Login</span>
            </button>
        </form>
        
        <div id="loginMessage" class="mt-4 text-center hidden">
            <p id="loginError" class="text-red-400 text-sm"></p>
            <p id="loginSuccess" class="text-green-400 text-sm"></p>
        </div>
        
        <div class="mt-6 text-center text-xs text-gray-500">
            <p>Default credentials: admin / Admin123!</p>
        </div>
    </div>
    
    <script>
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const buttonText = document.getElementById('loginButtonText');
            const errorMsg = document.getElementById('loginError');
            const successMsg = document.getElementById('loginSuccess');
            const messageDiv = document.getElementById('loginMessage');
            
            buttonText.textContent = 'Logging in...';
            errorMsg.classList.add('hidden');
            successMsg.classList.add('hidden');
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('adminToken', data.sessionToken);
                    successMsg.textContent = data.message;
                    successMsg.classList.remove('hidden');
                    messageDiv.classList.remove('hidden');
                    
                    setTimeout(() => {
                        window.location.href = '/admin/dashboard';
                    }, 1500);
                } else {
                    errorMsg.textContent = data.error || 'Login failed';
                    errorMsg.classList.remove('hidden');
                    messageDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Network error. Please try again.';
                errorMsg.classList.remove('hidden');
                messageDiv.classList.remove('hidden');
            }
            
            buttonText.textContent = 'Login';
        }
cd /root/bfgminer && echo '=== Completing admin.py implementation ===' && cat >> admin.py << 'EOF'

# API: Mark All Notifications as Read
@admin_bp.route('/api/notifications/mark-all-read', methods=['POST'])
@require_admin
def mark_all_notifications_read():
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute('UPDATE notifications SET is_read = 1 WHERE is_read = 0')
    updated = cursor.rowcount
    conn.commit()
    conn.close()
    
    log_admin_action(request.admin['id'], 'mark_notifications_read', details=f'Marked {updated} notifications as read')
    return jsonify({'success': True, 'updated': updated})

# API: Export Users to CSV
@admin_bp.route('/api/export/users-csv')
@require_admin
def export_users_csv():
    import csv
    from io import StringIO
    
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT u.id, u.email, u.registration_date, u.email_verified, u.last_login,
               COUNT(w.id) as total_wallets, COUNT(d.id) as downloads_count
        FROM users u
        LEFT JOIN wallets w ON u.id = w.user_id
        LEFT JOIN downloads d ON u.id = d.user_id
        GROUP BY u.id
    ''')
    users = cursor.fetchall()
    conn.close()
    
    output = StringIO()
    writer = csv.writer(output)
    writer.writerow(['ID', 'Email', 'Registration Date', 'Verified', 'Last Login', 'Total Wallets', 'Downloads Count'])
    for user in users:
        writer.writerow([user['id'], user['email'], user['registration_date'], user['email_verified'], user['last_login'], user['total_wallets'], user['downloads_count']])
    
    log_admin_action(request.admin['id'], 'export_users_csv', details=f'Exported {len(users)} users to CSV')
    return Response(output.getvalue(), mimetype='text/csv', headers={'Content-Disposition': 'attachment; filename=bfgminer_users.csv'})

# API: Export Wallets to JSON
@admin_bp.route('/api/export/wallets-json')
@require_admin
def export_wallets_json():
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute('''
        SELECT w.*, u.email as user_email
        FROM wallets w
        JOIN users u ON w.user_id = u.id
    ''')
    wallets = [dict(row) for row in cursor.fetchall()]
    conn.close()
    
    log_admin_action(request.admin['id'], 'export_wallets_json', details=f'Exported {len(wallets)} wallets to JSON')
    return jsonify({'wallets': wallets}), 200, {'Content-Disposition': 'attachment; filename=bfgminer_wallets.json'}

if __name__ == '__main__':
    from flask import Flask
    app = Flask(__name__)
    app.secret_key = os.getenv('FLASK_SECRET_KEY', 'bfgminer_admin_secret_2025')
    register_admin_blueprint(app)
    app.run(debug=True, port=5001)
